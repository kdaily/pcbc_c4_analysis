"""This only runs on belltown/sodo, a Sage Bionetworks cluster.

"""

import os
import csv

# For running synapse client, which requires python 2
PY2VIRTENV = "/home/ubuntu/.virtualenvs/python2/bin/activate"

SAMPLE_FILE = list(csv.DictReader(open("./input/sample_table.csv")))
SAMPLE_FILE = SAMPLE_FILE[:10]

SAMPLE_DICT = dict([(x["UID"], x) for x in SAMPLE_FILE])

# # For provenance
# BOWTIE2_SYNID = "syn3270408"
# EXPRESS_SYNID = "syn2243152"

def get_filename(wildcards):
    try:
        filename = '%s.bam' % SAMPLE_DICT[wildcards[0]]['UID']
    except Exception as e:
        print(e)
        print(wildcards)
        raise(e)
    
    return filename

def get_synid(wildcards):
    try:
        synid = SAMPLE_DICT[wildcards[0]]['id']
    except Exception as e:
        print(e)
        print(wildcards)
        raise(e)
    
    return synid

def get_sample_info(wildcards):
    try:
        info = SAMPLE_DICT[wildcards[0]]
    except Exception as e:
        print(e)
        print(wildcards)
        raise(e)
    
    return info

rule all:
     input: expand('output/{uid}.txt', uid=SAMPLE_DICT.keys())

# Create index file for fast bam access
rule process:
    input: "input/samples/{uid}.txt"
    output: final="output/{uid}.txt",bai='/tmp/{uid}/{uid}.bam.bai'
    params: uid='{uid}',scratchdir='/tmp',python2virtenv=PY2VIRTENV,synid=get_synid
    shell: """
           mkdir -p {params.scratchdir}/{params.uid}/ ; \
           # Get files from synapse
           source {params.python2virtenv}; \
           synapse get {params.synid} --downloadLocation {params.scratchdir}/{params.uid} ; \
           deactivate ; \
           
           samtools index {params.scratchdir}/{params.uid}/{params.uid}.bam ; \
           samtools flagstat {params.scratchdir}/{params.uid}/{params.uid}.bam > {output}
        """
