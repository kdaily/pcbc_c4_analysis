Quality Control Filtering and Normalization of methylation C4 data
===================================================================
```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(minfi)
library(lumi)
library(knitr)
library(rGithubClient)
library(plyr)
library(dplyr)
library(stringr)

library(synapseClient)
synapseLogin()

PROJECT_ID <- "syn4558491"
METHYLATIONMETA_ID <-'syn4587603'
OUTPUT_FOLDER_ID <- 'syn4588491'

```

```{r echo=FALSE}
repo <- getRepo("kdaily/pcbc_c4_analysis", ref="branch", refName="methyl_nathan")
script <- getPermlink(repo, "code/Rmd/normalize_methylation_nathan.Rmd")
```

```{r, echo=FALSE, include=FALSE, eval=FALSE}
library(knit2synapse)
knitfile2synapse(file="./normalize_methylation_nathan.Rmd", owner = "syn2233188",
                 wikiName = "Quality Control Filtering and Normalization of methylation data",
                 overwrite = TRUE)
```

### Find and download all of the idat files
I'm using annotations to get the metadata because the new samples have yet to be added to the metadata tables.
```{r downloadChunk, cache=TRUE}
fileList <- synQuery(sprintf('select id,name,UID from file where projectId=="%s" and fileType=="idat"', 
                             PROJECT_ID))

colnames(fileList) <- gsub("file\\.", "", colnames(fileList))

# Assumes in this directory
dataDir <- "/tmp/methylation_nathan/"

origNames <- fileList$name

fileListDistinct <- mutate(fileList, 
                           prettyName=str_replace(name, "(.*)_[RG].*", "\\1"),
                           Basename=str_join(dataDir, prettyName, sep="/"),
                           name=NULL, id=NULL) %>% distinct

files <- lapply(fileList$id,
                function (x) synGet(x, downloadLocation=dataDir))
```
### Load the methylation data
```{r readChunk, cache=TRUE, dependson="downloadChunk"}
RGSet <- read.450k.exp(targets=fileListDistinct)
```
### Add the metadata
As noted above, this code is a temporary fix until the metadata tables are updated with the proper information.
```{r}
metaTable <- synTableQuery(sprintf("select * from %s", METHYLATIONMETA_ID))

metaTbl <- metaTable@values %>% 
  select(-Channel) %>%
  distinct %>%
  left_join(fileListDistinct, by="UID")

rownames(metaTbl) <- metaTbl$prettyName

RGSet <- RGSet[, metaTbl$prettyName]
pData(RGSet) <- metaTbl[metaTbl$prettyName, ]
sampleNames(RGSet) <- pData(RGSet)$UID
meta <- pData(RGSet)
sampleNames(RGSet) <- pData(RGSet)$UID
```
### Compute methylated signals and observe the sample qualities
```{r plot_qualityChunk, fig.width=7, fig.height=6, cache=TRUE, dependson="filterChunk"}
MSet <- preprocessRaw(RGSet)
#Plot quality for datasets
qc <- getQC(MSet)
plotQC(qc)
```
### Detection level per sample
```{r fig.width=7, fig.height=6}
detP <- detectionP(RGSet)
failed <- detP > 0.01
plot(as.factor(pData(RGSet)$BeadChip), colMeans(failed), main='Mean Failure Rate per Sample', xlab='Array', ylab='mean # of probes with detection p value >0.01')
```
There are `r sum(rowMeans(failed)>0.05)` probes with detection p value >0.01 in >5% of samples.  Also it is clear that array 6264488096 has issues along with other samples.
### Perform quantile normalization
This also filters out these samples with low qc metrics.
```{r normalizeChunk, cache=TRUE, dependson="filterChunk"}
gRatioSet.quantile <- preprocessQuantile(RGSet, fixOutliers = TRUE,
                                         removeBadSamples = TRUE,
                                         badSampleCutoff = 10.5,
                                         quantileNormalize = TRUE,
                                         stratified = TRUE,
                                         mergeManifest = FALSE, 
                                         sex = NULL)

beta <- getBeta(gRatioSet.quantile)
```
These samples were removed:
```{r, echo=FALSE, results='asis'}
removed <- setdiff(colnames(RGSet), colnames(gRatioSet.quantile))

printCols <- c("UID", "source")

kable(pData(RGSet)[removed, printCols])
```
### MDS on source
#sub-sample the large matrix
```{r}
smaller <- beta[sample(nrow(gRatioSet.quantile), 10000), ]
```
# Dimensions 1 vs 2
```{r, fig.width=9}
plotSampleRelation(smaller, method='mds', cv.Th=0, 
                   color=pData(gRatioSet.quantile)$source)
```
# Dimensions 2 vs 3
```{r}
plotSampleRelation(smaller, method='mds', cv.Th=0, 
                   color=as.character(pData(gRatioSet.quantile)$source),
                   dimension=c(2,3))
```
# Dimensions 3 vs 4
```{r}
plotSampleRelation(smaller, method='mds', cv.Th=0, 
                   color=as.character(pData(gRatioSet.quantile)$source),
                   dimension=c(3,4))
```

### Store the normalized dataset in Synapse
```{r echo=FALSE, include=FALSE, eval=FALSE}
repo <- getRepo("kdaily/pcbc_c4_analysis", ref="branch", refName="methyl_nathan")
script <- getPermlink(repo, "code/Rmd/normalize_methylation_nathan.Rmd")

beta <- cbind(data.frame(ProbeID=rownames(beta)),
              beta)

write.table(beta, file='norm_methyl_matrix.tsv', sep='\t', row.names=FALSE, quote=FALSE)

file <- File('norm_methyl_matrix.tsv', name='Normalized Methylation Matrix',
             parentId=OUTPUT_FOLDER_ID)
synSetAnnotations(file) <- list(dataType="methylation", fileType="genomicMatrix")
usedFiles <- c('syn4558832', 'syn4558493')

act <- Activity(name="Normalize", 
                description="Normalize methylation using minfi and lumi", 
                used=usedFiles, executed=script)
generatedBy(file) <- act

data <- synStore(file)
```

```{r echo=FALSE, include=FALSE, eval=FALSE}
detP <- cbind(data.frame(ProbeID=rownames(detP)),
              detP)

write.table(detP, file='detectionPValues.tsv', sep='\t', row.names=FALSE, quote=FALSE)

detfile <- File('detectionPValues.tsv', name='Detection p-values',
                parentId=OUTPUT_FOLDER_ID)
synSetAnnotations(detfile) <- list(dataType="methylation", fileType="genomicMatrix")
usedFiles <- c('syn2653626')

act <- Activity(name="Detection p-values", 
                description="Determine detection significance per probe per sample.", 
                used='syn2653626', executed=(script))
generatedBy(detfile) <- act

data <- synStore(detfile)

```

